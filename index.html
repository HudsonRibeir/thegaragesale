<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garage Sale Hudson e Sthefanny</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBy_1o5ZxXElaD92C_h2XNZ4zdOEuM6aGg",
            authDomain: "garage-sale-ee8b6.firebaseapp.com",
            projectId: "garage-sale-ee8b6",
            storageBucket: "garage-sale-ee8b6.firebasestorage.app",
            messagingSenderId: "1069466264182",
            appId: "1:1069466264182:web:5100a3cd4d046884c1f557",
            databaseURL: "https://garage-sale-ee8b6-default-rtdb.firebaseio.com/"
        };

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    </script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
        }

        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            height: 100%;
        }

        .card:hover {
            transform: scale(1.05);
        }

        .card-img-top {
            height: 200px;
            object-fit: contain;
        }

        .modal-header {
            background-color: #8a2be2;
            color: white;
        }

        .btn-primary {
            background-color: #8a2be2;
            border-color: #8a2be2;
        }

        .btn-primary:hover {
            background-color: #4b0082;
            border-color: #4b0082;
        }

        .btn-primary:focus {
            background-color: #4b0082;
            border-color: #4b0082;
            box-shadow: 0 0 0 0.25rem rgba(138, 43, 226, 0.5);
        }

        .btn-primary:active {
            background-color: #4b0082 !important;
            border-color: #4b0082 !important;
        }

        .btn-primary:disabled {
            background-color: #d8bfff;
            border-color: #d8bfff;
        }

        .btn-secondary {
            background-color: #8a2be2;
            border-color: #8a2be2;
        }

        .btn-secondary:hover {
            background-color: #4b0082;
            border-color: #4b0082;
        }

        .btn-secondary:disabled {
            background-color: #d8bfff;
            border-color: #d8bfff;
        }

        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }

        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }

        .btn-success:disabled {
            background-color: #d8bfff;
            border-color: #d8bfff;
        }

        .btn-outline-primary {
            color: #8a2be2;
            border-color: #8a2be2;
        }

        .btn-outline-primary:hover {
            background-color: #8a2be2;
            border-color: #8a2be2;
            color: white;
        }

        .btn-outline-primary:disabled {
            color: #d8bfff;
            border-color: #d8bfff;
            background-color: transparent;
        }

        .btn-outline-primary:active {
            background-color: #4b0082 !important;
            border-color: #4b0082 !important;
            color: white !important;
        }

        .text-center {
            color: #343a40;
        }

        .text-primary {
            color: #8a2be2 !important;
        }

        .carousel-item img {
            height: 400px;
            object-fit: contain;
            cursor: zoom-in;
        }

        #imagemAmpliada {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(138, 43, 226, 0.9);
            z-index: 9999;
            cursor: zoom-out;
        }

        #imagemAmpliada img {
            max-width: 90%;
            max-height: 90%;
            margin: auto;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .miniaturas {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .miniatura {
            width: 80px;
            height: 80px;
            object-fit: contain;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .miniatura.active {
            border-color: #8a2be2;
        }

        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            filter: invert(19%) sepia(98%) saturate(5155%) hue-rotate(282deg) brightness(86%) contrast(112%);
            width: 3rem;
            height: 3rem;
        }

        .sub-item-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .sub-item-count {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .card-img-grid {
            display: grid;
            gap: 5px;
            height: 200px;
            overflow: hidden;
        }

        .card-img-grid.grid-1 {
            grid-template-columns: 1fr;
        }

        .card-img-grid.grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .card-img-grid.grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .card-img-grid.grid-4 {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }

        .card-img-grid.grid-6 {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }

        .card-img-grid.grid-9 {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
        }

        .card-img-grid.grid-12 {
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
        }

        .card-img-grid img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .no-image-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            background-color: #f8f9fa;
            color: #6c757d;
            font-style: italic;
            text-align: center;
            border: 1px dashed #dee2e6;
        }

        #tawk_677547d4af5bfec1dbe57fa5 {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .btn-close {
            border-color: #ffffff;
            background-color: #ffffff;
        }

        .total-value {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: right;
            font-size: 1.2em;
            font-weight: bold;
            display: none;
        }
    </style>
</head>

<body>
    <!-- Tela Inicial -->
    <div class="container my-5">
        <h1 class="text-center mb-4">Garage Sale Hudson e Sthefanny</h1>
        <p class="text-center mb-4">Estamos nos mudando para outro país e por isso estamos vendendo muitas coisas. Confira abaixo!</p>
        <p class="text-danger">
            Importante: O frete/transporte fica por conta do comprador. Para itens pequenos e compradores de Curitiba próximos à nossa região, podemos avaliar a possibilidade de entrega gratuita caso o item caiba em nosso carro.
        </p>

        <!-- Total a Receber -->
        <div class="total-value mb-4">
            Total a Receber: R$ <span id="total-value">0.00</span>
        </div>

        <!-- Botão de Perfil -->
        <div class="text-end mb-4">
            <button id="btnChat" class="btn btn-outline-primary" disabled>
                <span id="abrirChat" onclick="abrirChatModal()">Chat</span>
            </button>
            <button id="btnPerfil" class="btn btn-outline-primary">
                <span id="perfilStatus">Meus Dados</span>
            </button>
        </div>

        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <input type="text" id="filtro-produtos" class="form-control" placeholder="Procure um produto...">
            </div>
            <div class="col-md-3 mb-3">
                <select id="filtro-categoria" class="form-select">
                    <option value="">Todas as Categorias</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <select id="filtro-disponibilidade" class="form-select">
                    <option value="">Todos os Status</option>
                    <option value="true">Disponível</option>
                    <option value="false">Reservado</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <select id="ordenacao" class="form-select">
                    <option value="">Ordenar por...</option>
                    <option value="alfabetica">Ordem Alfabética</option>
                    <option value="categoria">Categoria</option>
                </select>
            </div>
        </div>
        <div class="row" id="produtos-container">
            <!-- Os produtos serão carregados dinamicamente aqui -->
        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div class="modal fade" id="detalhesModal" tabindex="-1" aria-labelledby="detalhesModalLabel">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detalhesModalLabel">Detalhes do Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="carouselExample" class="carousel slide mb-2" data-bs-ride="carousel">
                        <div class="carousel-inner" id="carousel-images">
                            <!-- As imagens serão carregadas dinamicamente aqui -->
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>

                    <div class="miniaturas mb-4" id="miniaturas-container">
                        <!-- As miniaturas serão carregadas dinamicamente aqui -->
                    </div>

                    <h2 id="detalhe-titulo" class="text-primary">Produto</h2>
                    <p><strong>Descrição:</strong> <span id="detalhe-descricao"></span></p>
                    <div id="detalhe-valor-container">
                        <p><strong>Valor:</strong> R$ <span id="detalhe-valor"></span></p>
                    </div>
                    <p><strong>Quantidade:</strong> <span id="detalhe-quantidade"></span></p>
                    <p><strong>Disponibilidade:</strong> <span id="detalhe-disponibilidade" class=""></span></p>
                    <p><strong>Data de Entrega:</strong> <span id="detalhe-data"></span></p>
                    <p><strong>Estado:</strong> <span id="detalhe-estado"></span></p>
                    <p><strong>Categoria:</strong> <span id="detalhe-categoria"></span></p>

                    <div class="sub-item-nav mb-3">
                        <button class="btn btn-outline-primary" id="prev-sub-item" style="display: none;">Anterior</button>
                        <span class="sub-item-count"></span>
                        <button class="btn btn-outline-primary" id="next-sub-item" style="display: none;">Próximo</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <div id="detalhe-chat-container">
                        <a href="#" id="detalhe-chat" class="btn btn-success" onclick="abrirChat(); return false;">Contatar via Chat</a>
                        <a href="#" id="detalhe-whatsapp" class="btn btn-success" onclick="contatarWhatsapp(); return false;">Contatar via WhatsApp</a>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Contato -->
    <div class="modal fade" id="contatoModal" tabindex="-1" aria-labelledby="contatoModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contatoModalLabel">Informações de Contato</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="contatoForm">
                        <div class="mb-3">
                            <label for="nome" class="form-label">Nome *</label>
                            <input type="text" class="form-control" id="nome" required>
                        </div>
                        <div class="mb-3">
                            <label for="whatsapp" class="form-label">WhatsApp</label>
                            <input type="tel" class="form-control" id="whatsapp">
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email">
                        </div>
                        <div class="text-danger" id="formError" style="display: none;">
                            Por favor, informe pelo menos um meio de contato (WhatsApp ou Email)
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="apagarDadosContato()">Apagar Dados</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarDadosContato()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal deChat -->
    <div class="modal fade" id="chatModal" tabindex="-2" aria-labelledby="chatModalLabel"">
        <div class=" modal-dialog" style="width: 356px;">
        <div class="modal-content p-0">
            <div class="modal-header">
                <h5 class="modal-title" id="chatModalLabel">Chat</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div id='tawk_677547d4af5bfec1dbe57fa5'></div>
            </div>
        </div>
    </div>
    </div>

    <!-- Container para imagem ampliada -->
    <div id="imagemAmpliada">
        <img src="" alt="Imagem Ampliada">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <!--Start of Tawk.to Script-->
    <script type="text/javascript">
        // Esta função cria a tag <script> do Tawk.to e injeta no DOM
        function inicializarChat() {
            // Se já estiver carregado, não carrega de novo
            if (window._tawkCarregado) {
                console.log("Tawk.to já foi carregado anteriormente.");
                return;
            }

            // Flags de controle (opcional)
            window._tawkCarregado = true;
            window.Tawk_LoadStart = new Date();

            // Se quiser um widget "embutido" em um <div> específico,
            // use a linha abaixo. Caso contrário, pode até omitir.
            window.Tawk_API = window.Tawk_API || {};
            window.Tawk_API.embedded = 'tawk_677547d4af5bfec1dbe57fa5';

            (function () {
                var s1 = document.createElement("script");
                var s0 = document.getElementsByTagName("script")[0];
                s1.async = true;
                s1.src = 'https://embed.tawk.to/677547d4af5bfec1dbe57fa5/1igh947p7';
                s1.charset = 'UTF-8';
                s1.setAttribute('crossorigin', '*');
                s0.parentNode.insertBefore(s1, s0);
            })();
        }
    </script>
    <!--End of Tawk.to Script-->
    <script>
        $(document).ready(function () {
            let currentSubItemIndex = 0;
            let currentSubItems = [];
            let currentProduto = null;
            let dadosUsuario = JSON.parse(localStorage.getItem('dadosUsuario') || '{}');
            let produtos = [];

            // Função para buscar produtos do Firebase
            function carregarProdutosDoFirebase() {
                const produtosRef = database.ref('produtos');
                produtosRef.on('value', (snapshot) => {
                    produtos = [];
                    snapshot.forEach((childSnapshot) => {
                        produtos.push(childSnapshot.val());
                    });
                    carregarCategorias();
                    carregarProdutos();
                });
            }

            carregarProdutosDoFirebase();

            // Função para calcular o total a receber
            function calcularTotalAReceber() {
                let total = 0;
                produtos.forEach(produto => {
                    if (!produto.pago && produto.valor) {
                        if (produto.subItems && produto.subItems.length > 0) {
                            produto.subItems.forEach(subItem => {
                                if (!subItem.pago && subItem.valor) {
                                    total += subItem.valor;
                                }
                            });
                        } else {
                            total += produto.valor;
                        }
                    }
                });
                $("#total-value").text(`R$ ${total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`);
            }

            // Atualiza o status do botão de perfil
            function atualizarBotaoPerfil() {
                const btnPerfil = $("#btnPerfil");
                if (dadosUsuario.nome) {
                    btnPerfil.html(`<i class="fas fa-user"></i> ${dadosUsuario.nome}`);
                } else {
                    btnPerfil.text("Cadastrar Dados");
                }
            }

            $("#btnPerfil").click(function () {
                if (dadosUsuario.nome) {
                    // Preenche o formulário com os dados existentes
                    $("#nome").val(dadosUsuario.nome);
                    $("#whatsapp").val(dadosUsuario.whatsapp);
                    $("#email").val(dadosUsuario.email);
                }
                $("#contatoModal").modal('show');
            });

            window.apagarDadosContato = function () {
                if (confirm("Tem certeza que deseja apagar seus dados?")) {
                    localStorage.removeItem('dadosUsuario');
                    dadosUsuario = {};
                    $("#nome").val('');
                    $("#whatsapp").val('');
                    $("#email").val('');
                    atualizarBotaoPerfil();
                    $("#contatoModal").modal('hide');
                }
            };

            window.salvarDadosContato = function () {
                const nome = $("#nome").val();
                const whatsapp = $("#whatsapp").val();
                const email = $("#email").val();

                if (!nome) {
                    $("#formError").text("Por favor, informe seu nome").show();
                    return;
                }

                if (!whatsapp && !email) {
                    $("#formError").text("Por favor, informe pelo menos um meio de contato (WhatsApp ou Email)").show();
                    return;
                }

                dadosUsuario = { nome, whatsapp, email };
                localStorage.setItem('dadosUsuario', JSON.stringify(dadosUsuario));

                $("#contatoModal").modal('hide');
                atualizarBotaoPerfil();

                // Se o modal foi aberto pelo chat, abre o chat após salvar os dados
                if (window.abrirChatAposSalvar) {
                    window.abrirChatAposSalvar = false;
                    abrirChatModal();
                    $("#btnChat").prop("disabled", false);
                } else if (window.abrirWhatsappAposSalvar) {
                    window.abrirWhatsappAposSalvar = false;
                    enviarMensagemWhatsapp();
                }
            };

            window.abrirChatModal = function () {

                inicializarChat();

                if (!dadosUsuario || Object.keys(dadosUsuario).length === 0) {
                    dadosUsuario = JSON.parse(localStorage.getItem('dadosUsuario') || '{}');
                }
                const produto = currentSubItems[currentSubItemIndex];

                setTimeout(() => {
                    waitForTawkAPI(() => {
                        window.Tawk_API.setAttributes({
                            "name": dadosUsuario.nome,
                            "email": dadosUsuario.email || "",
                            "phone": dadosUsuario.whatsapp || "",
                            "produto": produto.titulo,
                            "valor": produto.valor.toFixed(2),
                            "categoria": produto.categoria
                        }, function (error) {
                            if (error) {
                                console.error("Erro ao definir atributos no Tawk.to:", error);
                            } else {
                                console.log("Atributos definidos com sucesso!");
                            }
                        });


                        let tags = ["${produto.titulo}", "${produto.valor.toFixed(2)}"];
                        window.Tawk_API.addTags([produto.titulo], function (error) {
                            if (error) {
                                console.error("Erro ao adicionar tags no Tawk.to:", error);
                            } else {
                                console.log("Tags adicionadas com sucesso:", produto.titulo);
                            }
                        });
                    });
                }, 1000);

                $("#contatoModal").modal('hide');
                $("#chatModal").modal('show');
            }

            window.abrirChat = function () {
                $("#detalhesModal").modal('hide');

                if (dadosUsuario == null || dadosUsuario.nome == null) {
                    window.abrirChatAposSalvar = true;
                    window.abrirWhatsappAposSalvar = false;

                    $("#contatoModal").modal('show');
                    return;
                }

                abrirChatModal();
            };

            window.enviarMensagemWhatsapp = function () {
                const produto = currentSubItems[currentSubItemIndex];
                const mensagem = `Olá! Me chamo ${dadosUsuario.nome} e tenho interesse no produto: ${produto.titulo} - R$ ${produto.valor.toFixed(2)}. Meus contatos são: ${dadosUsuario.whatsapp ? 'WhatsApp: ' + dadosUsuario.whatsapp : ''} ${dadosUsuario.email ? 'Email: ' + dadosUsuario.email : ''}`;

                const whatsappUrl = `https://wa.me/5541999751101?text=${encodeURIComponent(mensagem)}`;
                window.open(whatsappUrl, '_blank');
            }

            window.contatarWhatsapp = function () {
                $("#detalhesModal").modal('hide');

                if (dadosUsuario == null || dadosUsuario.nome == null) {
                    window.abrirChatAposSalvar = false;
                    window.abrirWhatsappAposSalvar = true;
                    $("#contatoModal").modal('show');
                    return;
                }

                enviarMensagemWhatsapp();
            };

            function carregarCategorias() {
                const categorias = [...new Set(produtos.map(produto => produto.categoria))];
                const filtroCategoria = $("#filtro-categoria");
                filtroCategoria.empty();
                filtroCategoria.append('<option value="">Todas as Categorias</option>');
                categorias.forEach(categoria => {
                    filtroCategoria.append(`<option value="${categoria}">${categoria}</option>`);
                });
            }

            function carregarProdutos(filtroTexto = "", filtroCategoria = "", filtroDisponibilidade = "", ordenacao = "") {
                const container = $("#produtos-container");
                container.empty();

                // Mostrar/esconder o total baseado no filtro de texto
                if (filtroTexto.toLowerCase() === "stel&hud") {
                    $(".total-value").show();
                } else {
                    $(".total-value").hide();
                }

                let produtosFiltrados = produtos.filter(produto =>
                    produto.titulo.toLowerCase().includes(filtroTexto.toLowerCase()) &&
                    (filtroCategoria === "" || produto.categoria === filtroCategoria) &&
                    (filtroDisponibilidade === "" || produto.disponivel.toString() === filtroDisponibilidade)
                );

                if (ordenacao === "alfabetica") {
                    produtosFiltrados.sort((a, b) => a.titulo.localeCompare(b.titulo));
                } else if (ordenacao === "categoria") {
                    produtosFiltrados.sort((a, b) => a.categoria.localeCompare(b.categoria));
                }

                produtosFiltrados.forEach(produto => {
                    const subItems = produto.subItems || [];
                    let cardContent;

                    if (produto.entregue === true) {
                        return;
                    }

                    if (subItems.length > 0) {
                        if (subItems.some(item => item.imagens && item.imagens.length > 0)) {
                            const imagensGrid = subItems.map(item =>
                                item.imagens && item.imagens.length > 0
                                    ? `<img src="images/${item.imagens[0]}" alt="${item.titulo}">`
                                    : `<div class="no-image-placeholder">Em breve imagens</div>`
                            ).join('');
                            const gridClass = subItems.length <= 1 ? 'grid-1' :
                                subItems.length <= 2 ? 'grid-2' :
                                    subItems.length <= 3 ? 'grid-3' :
                                        subItems.length <= 4 ? 'grid-4' :
                                            subItems.length <= 6 ? 'grid-6' :
                                                subItems.length <= 9 ? 'grid-9' : 'grid-12';
                            cardContent = `<div class="card-img-grid ${gridClass}">${imagensGrid}</div>`;
                        } else {
                            cardContent = `<div class="no-image-placeholder">Em breve imagens</div>`;
                        }
                    } else {
                        if (produto.imagens && produto.imagens.length > 0) {
                            cardContent = `<img src="images/${produto.imagens[0]}" alt="${produto.titulo}" class="card-img-top">`;
                        } else {
                            cardContent = `<div class="no-image-placeholder">Em breve imagens</div>`;
                        }
                    }

                    container.append(`
                        <div class="col-md-4 mb-4">
                            <div class="card" onclick="verDetalhes(${produto.id})">
                                ${cardContent}
                                <div class="card-body">
                                    <h5 class="card-title">${produto.titulo}</h5>
                                    <p class="card-text">Categoria: ${produto.categoria}</p>
                                    ${subItems.length > 0 ? '' : produto.disponivel && produto.valor > 0 ?
                            produto.precoCerto ?
                                `<p class="card-text">Valor: R$ ${produto.valor.toFixed(2)}</p>` :
                                `<p class="card-text text-danger">Preço não definido, quer fazer uma proposta?</p>`
                            : produto.disponivel ? `<p class="card-text">Doação</p>` : ''}
                                    <p class="card-text">Quantidade: ${subItems.length > 0 ? subItems.length + ' itens' : produto.quantidade}</p>
                                    <p class="card-text ${produto.pago ? 'text-danger' : produto.disponivel ? 'text-success' : 'text-warning'}">
                                        ${produto.pago ? 'Vendido' : produto.disponivel ? 'Disponível' : `Reservado${produto.reservadoPara ? ` (${produto.reservadoPara})` : ''}`}
                                    </p>
                                    <button class="btn btn-primary" onclick="verDetalhes(${produto.id})">Ver Detalhes</button>
                                </div>
                            </div>
                        </div>
                    `);
                });

                // Atualiza o total a receber após carregar os produtos
                calcularTotalAReceber();
            }

            $("#filtro-produtos, #filtro-categoria, #filtro-disponibilidade, #ordenacao").on("change input", function () {
                carregarProdutos(
                    $("#filtro-produtos").val(),
                    $("#filtro-categoria").val(),
                    $("#filtro-disponibilidade").val(),
                    $("#ordenacao").val()
                );
            });

            function atualizarNavegacaoSubItems() {
                if (currentSubItems.length > 1) {
                    $("#prev-sub-item").show();
                    $("#next-sub-item").show();
                    $(".sub-item-count").text(`${currentSubItemIndex + 1} de ${currentSubItems.length}`);
                } else {
                    $("#prev-sub-item").hide();
                    $("#next-sub-item").hide();
                    $(".sub-item-count").text('');
                }

                $("#prev-sub-item").prop('disabled', currentSubItemIndex === 0);
                $("#next-sub-item").prop('disabled', currentSubItemIndex === currentSubItems.length - 1);
            }

            $("#prev-sub-item").click(function () {
                if (currentSubItemIndex > 0) {
                    currentSubItemIndex--;
                    mostrarSubItem(currentSubItems[currentSubItemIndex]);
                }
            });

            $("#next-sub-item").click(function () {
                if (currentSubItemIndex < currentSubItems.length - 1) {
                    currentSubItemIndex++;
                    mostrarSubItem(currentSubItems[currentSubItemIndex]);
                }
            });

            function mostrarSubItem(item) {
                $("#detalhe-titulo").text(item.titulo);
                $("#detalhe-descricao").text(item.descricao);

                // Mostra ou esconde o valor baseado na disponibilidade
                if (item.disponivel) {
                    $("#detalhe-valor-container").show();
                    if (item.precoCerto) {
                        $("#detalhe-valor").text(item.valor.toFixed(2));
                    } else {
                        $("#detalhe-valor").html('<span class="text-danger">Preço não definido, quer fazer uma proposta?</span>');
                    }
                } else {
                    $("#detalhe-valor-container").hide();
                }

                // Define a cor do texto de disponibilidade
                $("#detalhe-disponibilidade")
                    .text(item.disponivel ? 'Disponível' : 'Reservado')
                    .removeClass('text-success text-danger')
                    .addClass(item.disponivel ? 'text-success' : 'text-danger');

                $("#detalhe-quantidade").text(item.quantidade);
                $("#detalhe-data").text(item.dataEntrega);
                $("#detalhe-estado").text(item.estado);
                $("#detalhe-categoria").text(item.categoria);

                // Mostra ou esconde o botão de chat baseado na disponibilidade
                $("#detalhe-chat-container").toggle(item.disponivel);

                const carousel = $("#carousel-images");
                const miniaturas = $("#miniaturas-container");
                carousel.empty();
                miniaturas.empty();

                if (item.imagens && item.imagens.length > 0) {
                    item.imagens.forEach((imagem, index) => {
                        carousel.append(`
                            <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                <img src="images/${imagem}" class="d-block w-100" alt="Foto ${index + 1}" onclick="ampliarImagem('images/${imagem}')">
                            </div>
                        `);

                        miniaturas.append(`
                            <img src="images/${imagem}" 
                                class="miniatura ${index === 0 ? 'active' : ''}" 
                                alt="Miniatura ${index + 1}"
                                onclick="mudarImagem(${index})"
                            >
                        `);
                    });
                } else {
                    carousel.append(`
                        <div class="carousel-item active">
                            <div class="no-image-placeholder">Em breve imagens</div>
                        </div>
                    `);
                }

                atualizarNavegacaoSubItems();
            }

            window.verDetalhes = function (id) {
                const produto = produtos.find(p => p.id === id);
                if (produto) {
                    currentProduto = produto;
                    currentSubItems = produto.subItems || [produto];
                    currentSubItemIndex = 0;
                    mostrarSubItem(currentSubItems[currentSubItemIndex]);
                    $("#detalhesModal").modal('show');
                }
            };

            function waitForTawkAPI(callback, tentativas = 0) {
                // Aqui verificamos se Tawk_API já está disponível e tem o método setAttributes()
                if (
                    typeof window.Tawk_API !== 'undefined' &&
                    typeof window.Tawk_API.setAttributes === 'function'
                ) {
                    callback(); // Se sim, chamamos o callback
                } else {
                    // Se ainda não, tentamos novamente em 200ms, até um limite
                    if (tentativas < 50) { // 50 tentativas = 10 segundos
                        setTimeout(() => waitForTawkAPI(callback, tentativas + 1), 200);
                    } else {
                        console.error("Tawk_API não carregou dentro do tempo esperado.");
                    }
                }
            }

            window.mudarImagem = function (index) {
                $('#carouselExample').carousel(index);
                $('.miniatura').removeClass('active');
                $('.miniatura').eq(index).addClass('active');
            }

            $('#carouselExample').on('slide.bs.carousel', function (e) {
                $('.miniatura').removeClass('active');
                $('.miniatura').eq(e.to).addClass('active');
            });

            window.ampliarImagem = function (src) {
                const container = $("#imagemAmpliada");
                container.find("img").attr("src", src);
                container.show();
            }

            $("#imagemAmpliada").click(function () {
                $(this).hide();
            });

            carregarCategorias();
            carregarProdutos();
            atualizarBotaoPerfil();
        });
    </script>
</body>

</html>